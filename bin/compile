#!/usr/bin/env ruby

require 'tempfile'
require 'fileutils'

$stdout.sync = true

def indent msg
  puts "       #{msg}"
end

puts "-----> Found a .oracle.ini"

OCI8_SOURCE_URL = "http://dl.bintray.com/kubo/generic/ruby-oci8-2.1.7.tar.gz"

OCI8_BUILD_DIR="#{ARGV[0]}/vendor/oci8"
OCI8_DIR="#{ARGV[0]}/vendor/oci8/"

`mkdir -p #{OCI8_BUILD_DIR} && mkdir -p #{OCI8_DIR}`

indent "Downloading Ruby OCI8 source"
result = `curl #{OCI8_SOURCE_URL} -s -o - | tar -xz -C #{OCI8_BUILD_DIR} -f - `
indent `ruby --version`
indent "Configuring Ruby OCI8"
result = `cd #{OCI8_BUILD_DIR} && echo "In folder " && ls -alh . && ./configure --prefix=#{OCI8_DIR} 2>&1`

indent "Compiling Ruby OCI8"
result = `cd #{OCI8_BUILD_DIR} && make install 2>&1`

result = `ls -alh #{OCI8_DIR} 2>&1 `
raise "Install folder is\n #{result}"

S3BUCKET="https://s3.amazonaws.com/chameleon-heroku-assets"
OCI8_TGZ="#{S3BUCKET}/ruby-2.0.0-oci8.tar.gz"
ORACLE_INSTANT_CLIENT_TGZ="#{S3BUCKET}/instantclient_11_2_with_libaio_oci8.tar.gz"

BUILD_DIR="#{ARGV[0]}/oracle_oci8"
OCI8_DIR="#{ARGV[0]}/vendor/oci8"
version = `cat #{ARGV[0]}/.ruby-version`
version = 'ruby-2.0.0' if version.nil?
OCI8_SO_DIR="#{ARGV[0]}/vendor/#{version}/" 

ORACLE_INSTANT_CLIENT_DIR="#{ARGV[0]}/vendor/oracle_instantclient"

indent "Making folders..."
`mkdir -p #{OCI8_SO_DIR}`
`mkdir -p #{OCI8_DIR}`
`mkdir -p #{ORACLE_INSTANT_CLIENT_DIR}`

indent "Downloading and extracting archives from #{S3BUCKET}..."
result = `curl #{OCI8_TGZ} -s -o - | tar -xz -C #{OCI8_SO_DIR} -f - `

unless $?.success?
  indent "Failure while downloading OCI8 archive: #{$?}"
  exit 1
end

result = `curl #{ORACLE_INSTANT_CLIENT_TGZ} -s -o - | tar -xz -C #{ORACLE_INSTANT_CLIENT_DIR} -f - `

unless $?.success?
  indent "Failure while downloading Oracle instant client archive: #{$?}"
  exit 1
end

indent "Done."
